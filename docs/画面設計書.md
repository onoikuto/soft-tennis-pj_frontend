# 画面設計書

## 1. 概要

- **アプリケーション名**: ソフトテニス採点アプリ
- **フレームワーク**: Flutter
- **プラットフォーム**: iOS, Android, Web
- **状態管理**: StatefulWidget + setState

## 2. 画面一覧

| 画面名 | ファイル名 | 説明 |
|--------|-----------|------|
| メインメニュー | `main_menu_screen.dart` | アプリのホーム画面 |
| 試合設定 | `match_setup_screen.dart` | 新規試合の設定 |
| 採点画面 | `official_scoring_screen.dart` | 試合中のスコア入力 |
| 試合履歴 | `match_history_screen.dart` | 過去の試合一覧 |
| 統計ダッシュボード | `statistics_screen.dart` | 統計データの表示 |
| マイページ | `my_page_screen.dart` | ユーザー情報と設定 |
| アカウント設定 | `account_settings_screen.dart` | アカウント情報の編集 |

## 3. 画面詳細

### 3.1 メインメニュー画面（MainMenuScreen）

**ファイル**: `lib/screens/main_menu_screen.dart`

#### 機能概要
アプリのホーム画面。主要機能へのナビゲーションを提供します。

#### UI構成

**ヘッダー**
- タイトル: "Main Menu"（小文字、灰色）

**メインコンテンツ**（スクロール可能）
- **新しく試合を始める** ボタン
  - タイトル: "新しく試合を始める"
  - サブタイトル: "New Match"
  - アクション: `MatchSetupScreen` へ遷移
- **過去の試合一覧** ボタン
  - タイトル: "過去の試合一覧"
  - サブタイトル: "Match History"
  - アクション: ボトムナビゲーションの「履歴」タブ（index 1）に切り替え
- **統計データ** ボタン
  - タイトル: "統計データ"
  - サブタイトル: "Statistics"
  - アクション: ボトムナビゲーションの「統計」タブ（index 2）に切り替え

**ボトムナビゲーション**
- ホーム（index 0）
- 履歴（index 1）
- 統計（index 2）
- マイページ（index 3）

#### データフロー
- データベースアクセスなし
- ナビゲーションのみ

#### 状態管理
- `_currentIndex`: 現在選択中のボトムナビゲーションインデックス

---

### 3.2 試合設定画面（MatchSetupScreen）

**ファイル**: `lib/screens/match_setup_screen.dart`

#### 機能概要
新規試合の設定を行う画面。プレイヤー情報、大会名、ゲーム数などを入力します。

#### UI構成

**AppBar**
- タイトル: "試合設定"
- 戻るボタン: 閉じるアイコン

**フォーム**（スクロール可能）
- **大会・イベント名**（必須）
  - 入力フィールド: `TextFormField`
  - バリデーション: 必須入力
- **ペアA**
  - **プレイヤー1**（必須）
  - **プレイヤー2**（必須）
  - **所属**（必須）
- **ペアB**
  - **プレイヤー1**（必須）
  - **プレイヤー2**（必須）
  - **所属**（必須）
- **ゲーム数**
  - ラジオボタン: 5ゲーム / 7ゲーム / 9ゲーム
  - デフォルト: 7ゲーム
- **先サーブ**
  - ラジオボタン: ペアA / ペアB
  - デフォルト: なし（必須ではない）

**アクションボタン**
- **試合を開始する** ボタン
  - バリデーション成功時のみ有効
  - アクション: データベースに保存 → `OfficialScoringScreen` へ遷移

#### データフロー
1. ユーザー入力
2. バリデーション
3. `Match` オブジェクト作成
4. `DatabaseHelper.instance.insertMatch()` で保存
5. 作成された `matchId` を `OfficialScoringScreen` に渡す

#### 状態管理
- `_formKey`: フォームバリデーション用
- `_tournamentController`: 大会名入力
- `_team1Player1Controller`, `_team1Player2Controller`, `_team1ClubController`: ペアA情報
- `_team2Player1Controller`, `_team2Player2Controller`, `_team2ClubController`: ペアB情報
- `_gameCount`: 選択中のゲーム数（5, 7, 9）
- `_firstServe`: 選択中の先サーブ（'team1' または 'team2'）

---

### 3.3 採点画面（OfficialScoringScreen）

**ファイル**: `lib/screens/official_scoring_screen.dart`

#### 機能概要
試合中のスコア入力と管理を行う画面。ポイント追加、ゲーム管理、試合終了判定などを行います。

#### UI構成

**AppBar**
- タイトル: 大会名（または "試合"）
- 戻るボタン: なし（試合中は戻れない）

**メインコンテンツ**
- **試合情報表示**
  - チーム1名（ペアA）
  - チーム2名（ペアB）
  - ゲーム数設定

- **スコアテーブル**（横スクロール可能）
  - 列構成:
    - S（サーブ権表示）
    - 1, 2, 3, ..., 9（ゲーム番号）
  - 行構成:
    - チーム1行: 各ゲームのポイント数
    - チーム2行: 各ゲームのポイント数
  - 現在のゲームのサーブ権に ⚪ マークを表示
  - ファイナルゲームは "ファイナルゲーム" と表示

- **ポイント追加ボタン**
  - チーム1用ボタン（試合完了時は無効化）
  - チーム2用ボタン（試合完了時は無効化）

- **アクションボタン**
  - **一つ戻る** ボタン（常に有効）
    - 最後のポイントを削除
    - 試合完了状態も解除可能
  - **試合終了** ボタン
    - 試合完了時: 確認なしで `MainMenuScreen` へ遷移
    - 試合未完了時: 2段階確認ダイアログ表示

#### ゲームルール実装

**通常ゲーム**
- 4ポイント先取で勝利（2ポイント差が必要）
- デュース: 3-3以降は2ポイント差がつくまで継続

**ファイナルゲーム**
- 条件: ゲーム数に達した時点で同点の場合
- 7ポイント先取で勝利（2ポイント差が必要）
- デュース: 6-6以降は2ポイント差がつくまで継続
- サーブ権: 2ポイントごとに交代

**サーブ権**
- 通常ゲーム: ゲームごとに交代（勝敗に関係なく）
- ファイナルゲーム: 2ポイントごとに交代

**試合終了条件**
- 5ゲームマッチ: 先に3ゲーム取得
- 7ゲームマッチ: 先に4ゲーム取得
- 9ゲームマッチ: 先に5ゲーム取得

#### データフロー
1. `initState`: `matchId` から試合データとゲームスコアを読み込み
2. ポイント追加:
   - 現在のゲームスコアを取得または新規作成
   - ポイントをインクリメント
   - ゲーム終了判定
   - サーブ権更新
   - データベースに保存
   - 試合終了判定
3. 一つ戻る:
   - 最後のゲームスコアを取得
   - ポイントをデクリメントまたはゲームを削除
   - データベースを更新
   - 試合完了状態を再評価

#### 状態管理
- `_match`: 現在の試合情報
- `_gameScores`: 全ゲームスコアのリスト
- `_currentGame`: 現在進行中のゲーム番号
- `_isLoading`: データ読み込み中フラグ
- `_isMatchCompleted`: 試合完了フラグ

---

### 3.4 試合履歴画面（MatchHistoryScreen）

**ファイル**: `lib/screens/match_history_screen.dart`

#### 機能概要
過去の試合一覧を表示します。試合の詳細確認や削除が可能です。

#### UI構成

**AppBar**
- タイトル: "過去の試合一覧"

**メインコンテンツ**（プルリフレッシュ対応）
- **空状態**
  - アイコン: `Icons.history`
  - メッセージ: "試合履歴がありません"

- **試合リスト**（`ListView`）
  - 各試合は `Card` で表示
  - **試合情報**
    - タイトル: 大会名（空の場合は "試合"）
    - サブタイトル:
      - チーム1名
      - "vs"
      - チーム2名
      - 作成日時（yyyy/MM/dd HH:mm形式）
  - **ステータス表示**（`trailing`）
    - 完了: 緑色のチップ（"チーム1勝利" / "チーム2勝利" / "終了"）
    - 進行中: オレンジ色のチップ（"進行中"）
  - **削除ボタン**（赤いゴミ箱アイコン）
    - クリックで削除確認ダイアログ表示

#### データフロー
1. `initState`: `DatabaseHelper.instance.getAllMatches()` で全試合を取得
2. 試合タップ: `OfficialScoringScreen` へ遷移（`matchId` を渡す）
3. 削除:
   - 確認ダイアログ表示
   - 承認時: `DatabaseHelper.instance.deleteMatch()` で削除
   - リストを再読み込み
   - スナックバーで完了通知

#### 状態管理
- `_matches`: 試合一覧
- `_isLoading`: データ読み込み中フラグ

---

### 3.5 統計ダッシュボード画面（StatisticsScreen）

**ファイル**: `lib/screens/statistics_screen.dart`

#### 機能概要
試合データの統計を表示します。ペア単位、学校・クラブ単位、人単位で集計可能です。

#### UI構成

**AppBar**
- タイトル: "統計ダッシュボード"

**メインコンテンツ**（スクロール可能）
- **セグメントコントロール**
  - ペア単位 / 学校・クラブ単位 / 人単位

- **選択ボタン**
  - クリックで検索可能なダイアログを表示
  - 選択中の項目名を表示

- **選択中の表示**
  - アイコン + "選択中: [項目名]"

- **統計カード**
  1. **通算試合数と勝率**
     - 総試合数
     - 勝率（%）
  2. **ゲーム別の得点率**
     - 各ゲーム（1-9）の勝率をプログレスバーで表示
  3. **デュース時取得率**
     - ドーナツチャートで表示
     - デュース時の勝率
  4. **サーブ・レシーブ別取得率**
     - サーブ時の勝率
     - レシーブ時の勝率
  5. **データインサイト**
     - テキスト形式の分析結果

#### データフロー
1. `initState`: 全試合データを読み込み、ペア/組織/個人のリストを生成
2. 単位選択: セグメントコントロールで切り替え
3. 項目選択: ダイアログから選択
4. 統計計算:
   - 選択された項目に関連する試合をフィルタリング
   - 各統計を計算
   - UIを更新

#### 状態管理
- `_selectedView`: 選択中の単位（0: ペア, 1: 組織, 2: 個人）
- `_selectedPair`: 選択中の項目名
- `_pairs`, `_organizations`, `_players`: 各単位のリスト
- `_filteredItems`: 検索フィルタリング後のリスト
- `_searchController`: 検索入力
- `_isLoading`: データ読み込み中フラグ
- 各種統計データ（`_totalMatches`, `_winRate`, `_gameWinRates`, など）

---

### 3.6 マイページ画面（MyPageScreen）

**ファイル**: `lib/screens/my_page_screen.dart`

#### 機能概要
ユーザー情報の表示と各種設定へのアクセスを提供します。

#### UI構成

**AppBar**
- タイトル: "マイページ"

**メインコンテンツ**（スクロール可能）
- **プロフィールセクション**
  - 名前（苗字 + 名前）
  - 所属チーム

- **アカウント設定セクション**
  - **アカウント設定**
    - アイコン: `Icons.manage_accounts`
    - アクション: `AccountSettingsScreen` へ遷移

- **データのバックアップと移行セクション**
  - **データのエクスポート (書き出し)**
    - アイコン: `Icons.upload`
    - アクション: `BackupScreen` へ遷移
  - **データのインポート (読み込み)**
    - アイコン: `Icons.download`
    - アクション: `BackupScreen` へ遷移
  - フッター: "CSVや専用形式で試合データを保存・復元できます"

- **バージョン情報**
  - "Version 1.0.2"

#### データフロー
1. `initState`: `SharedPreferences` からアカウント設定を読み込み
2. アカウント設定から戻る: 設定が保存された場合、プロフィール情報を再読み込み

#### 状態管理
- `_lastName`, `_firstName`, `_team`: `SharedPreferences` から読み込んだ値
- `_displayName`: 表示用の名前（デフォルト値あり）
- `_displayTeam`: 表示用の所属（デフォルト値あり）

---

### 3.7 アカウント設定画面（AccountSettingsScreen）

**ファイル**: `lib/screens/account_settings_screen.dart`

#### 機能概要
ユーザーのアカウント情報（名前、所属）を編集します。

#### UI構成

**AppBar**
- タイトル: "アカウント設定"
- 戻るボタン: 矢印アイコン

**フォーム**（スクロール可能）
- **苗字**（必須）
  - 入力フィールド: `SimpleTextField`
  - バリデーション: 必須入力
- **名前**（任意）
  - 入力フィールド: `SimpleTextField`
- **所属チーム**（任意）
  - 入力フィールド: `SimpleTextField`

**アクションボタン**
- **保存する** ボタン
  - バリデーション成功時のみ有効
  - アクション: `SharedPreferences` に保存 → 前画面へ戻る（`true` を返す）

#### データフロー
1. `initState`: `SharedPreferences` から既存の設定を読み込み、フィールドに設定
2. 保存:
   - バリデーション
   - `SharedPreferences` に保存
   - スナックバーで完了通知
   - `Navigator.pop(context, true)` で前画面へ戻る

#### 状態管理
- `_formKey`: フォームバリデーション用
- `_lastNameController`, `_firstNameController`, `_teamController`: 各入力フィールドのコントローラー

---

## 4. ナビゲーションフロー

```
MainMenuScreen (ホーム)
├─ MatchSetupScreen (試合設定)
│  └─ OfficialScoringScreen (採点)
│     └─ MainMenuScreen (試合終了時)
│
├─ MatchHistoryScreen (履歴タブ)
│  └─ OfficialScoringScreen (試合詳細)
│
├─ StatisticsScreen (統計タブ)
│
└─ MyPageScreen (マイページタブ)
   ├─ AccountSettingsScreen (アカウント設定)
   └─ BackupScreen (バックアップ)
```

## 5. 共通コンポーネント

### 5.1 SimpleBottomNavigationBar
- 4つのタブ（ホーム、履歴、統計、マイページ）
- 現在のタブをハイライト表示

### 5.2 SimpleLargePrimaryButton
- 大きなプライマリボタン
- タイトルとサブタイトルを表示

### 5.3 SimpleSecondaryButton
- セカンダリボタン
- タイトルとサブタイトルを表示

### 5.4 SimpleTextField
- 統一されたスタイルのテキスト入力フィールド

---

## 6. データ永続化

### 6.1 SQLite（試合データ）
- `DatabaseHelper` クラスで管理
- `matches` テーブル: 試合情報
- `game_scores` テーブル: ゲームスコア

### 6.2 SharedPreferences（ユーザー設定）
- アカウント設定（名前、所属）を保存
- キー:
  - `account_last_name`
  - `account_first_name`
  - `account_team`

---

## 7. UI/UX設計原則

### 7.1 カラースキーム
- 背景色: `#FCFCFC`, `#FDFCFB`
- テキスト色: `#333333`, `#666666`, `#888888`
- プライマリカラー: `#000000`
- アクセントカラー: `#1E293B`

### 7.2 タイポグラフィ
- タイトル: 18-20px, FontWeight.w500-w600
- 本文: 14-16px, FontWeight.normal
- サブテキスト: 12px, FontWeight.normal

### 7.3 スペーシング
- パディング: 16-24px
- マージン: 8-16px
- 角丸: 10-16px

### 7.4 レスポンシブデザイン
- スコアテーブル: 横スクロール対応
- 統計カード: 画面サイズに応じて調整
- フォントサイズ: 画面サイズに応じて動的調整

---

## 8. エラーハンドリング

### 8.1 データベースエラー
- 読み込み失敗時: エラーメッセージ表示
- 保存失敗時: スナックバーで通知

### 8.2 バリデーションエラー
- フォーム入力エラー: フィールド下にエラーメッセージ表示
- 必須項目未入力: 赤いエラーテキスト表示

### 8.3 ネットワークエラー
- オフラインアプリのため、ネットワークエラーは発生しない

---

## 9. パフォーマンス最適化

### 9.1 データ読み込み
- 必要時のみデータベースアクセス
- リスト表示時はページネーションなし（全件取得）

### 9.2 UI更新
- `setState` で必要な部分のみ更新
- 不要な再ビルドを避ける

### 9.3 メモリ管理
- `TextEditingController` の適切な `dispose`
- 不要なデータのクリア
